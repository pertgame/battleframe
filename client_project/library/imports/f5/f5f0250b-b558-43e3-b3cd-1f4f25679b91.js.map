{"version":3,"sources":["assets/scripts/wsNet.js"],"names":["Global","require","HeartCheck","timeout","svrtimeout","timeoutObj","serverTimeoutObj","disconnectioned","reconnectTimeoutobj","reset","clearTimeout","startHeartBeat","self","setTimeout","cc","log","ws","buff","ArrayBuffer","data","Uint32Array","MID_HeartBeat","send","close","hasDisconnected","stopReconnectTimer","MessageStateFunc","onlogin","mySessionId","LoginSucc","nodex","nodey","MosterPosX","MosterPosY","MonsterScore","onlogout","key","toString","DelPlayerIds","push","PlayerSessionMap","onmove","playerProp","sessionId","has","set","NewplayerMap","newPlayerIds","onBump","BumpedPlayerId","starProp","newStarPos","newStarKey","onHeartBeat","onStarBorn","onGM","Online4Other","syncOnline4Other","onRegister","RegisterSucc","onSyncPos","onMonsterInfo","onLogicFrameSync","Class","CanSendMsg","readyState","WebSocket","CONNECTING","OPEN","swConnect","wsAddr","onopen","e","onmessage","msgid","MID_login","MID_logout","MID_move","MID_Bump","MID_StarBorn","MID_GM","MID_Online4Other","MID_Register","MID_SyncPos","MID_MonsterInfo","MID_LogicFrameSync","onerror","onclose","sendwsmessage","CLOSED","CLOSING"],"mappings":"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","sourceRoot":"/","sourcesContent":["/**\n * websocket \n */\n\nlet Global = require(\"common\")\n\n//心跳检测\nvar HeartCheck = {\n    timeout: 50000, //50秒 稍微比服务器小一点，让服务器网络波动有个缓冲时间\n    svrtimeout: 60000, //60秒\n    timeoutObj: null,\n    serverTimeoutObj: null,\n    disconnectioned: false,\n    reconnectTimeoutobj: null,\n\n    reset: function() {\n        clearTimeout(this.timeoutObj);\n        clearTimeout(this.serverTimeoutObj);\n        return this;\n    },\n\n    startHeartBeat: function() {\n        var self = this;\n        this.timeoutObj = setTimeout(function() {\n            //这里发送一个心跳，后端收到后，返回一个心跳消息，onmessage拿到返回的心跳就说明连接正常\n            cc.log(\"send heart beat...\")\n            if (Global.ws == null) {\n                return\n            } \n\n            var buff = new ArrayBuffer(12)\n            var data = new Uint32Array(buff)\n    \n            data[0] = Global.MID_HeartBeat //消息ID\n            data[1] = 1 //消息长度\n            data[2] = 0 //anything 随意填充一个数\n\n            Global.ws.send(data);\n            self.serverTimeoutObj = setTimeout(function() { //心跳超时主动断开\n                cc.log(\"close connection...\")\n                if (Global.ws == null) {\n                    return\n                } \n                Global.ws.close();\n                //self.disconnectioned = true\n            }, self.svrtimeout)\n        }, this.timeout)\n    },\n\n    hasDisconnected: function(){\n        return this.disconnectioned\n    },\n\n    stopReconnectTimer: function(){\n        //cc.log(\"close reconnectTimeout...\")\n        clearTimeout(this.reconnectTimeoutobj);\n    }\n}\n\n/**\n * 消息回复处理\n */\nvar MessageStateFunc = {\n    /**\n     * 消息解析 \n     * 0: 消息id\n     * 1：消息长度\n     * 2：sessionid\n     * 3：nodex x坐标正负标记\n     * 4：nodex x坐标值\n     * 5：nodey y坐标正负标记\n     * 6：nodey y坐标值 \n     */\n    onlogin: function(data) {\n        \n        if (data[2] == 1) {\n            Global.mySessionId = data[3]\n        }else{\n            return\n        }\n\n        cc.log(\"ws message MID_login: \", data[2], data[3], data[4], data[5], data[6], data[7], data[8])\n        Global.LoginSucc = data[2]\n        var nodex = data[5]\n        var nodey = data[7]\n        if (data[4] == 2){\n            nodex = 0 - nodex\n        }\n        if (data[6] == 2){\n            nodey = 0 - nodey\n        }\n        Global.MosterPosX = nodex\n        Global.MosterPosY = nodey\n        Global.MonsterScore = data[8]\n    },\n\n    onlogout: function(data) {\n        var key = data[2].toString()\n        cc.log(\"ws message MID_logout, sessionid: \", key)\n        Global.DelPlayerIds.push(key)\n        Global.PlayerSessionMap.delete(key)\n    },\n\n    onmove: function(data) {\n        cc.log(\"ws message MID_move: \", data[1], data[2], data[3], data[4], data[5], data[6])\n        var key = data[6].toString()\n        var nodex = data[3]\n        var nodey = data[5]\n        if (data[2] == 2){\n            nodex = 0 - nodex\n        }\n        if (data[4] == 2){\n            nodey = 0 - nodey\n        }\n        var playerProp = {\n            sessionId: data[6],\n            nodex: nodex,\n            nodey: nodey\n        }\n        if (Global.PlayerSessionMap.has(key) == false) {\n            Global.PlayerSessionMap.set(key, playerProp)\n        }\n        Global.NewplayerMap.set(key, playerProp)\n        Global.newPlayerIds.push(key)\n        //cc.log(\"MID_move purple monsters: \", Global.newPlayerIds.length, key, Global.NewplayerMap.has(key))\n    },\n\n    onBump: function (data) {\n        /**\n         *  0: 消息ID\n            1：消息长度\n            2: 成功失败标志 (失败则只需要前三个字段)\n            3: 星星x坐标正负标志\n            4: 星星x坐标\n            5：星星y坐标正负标志\n            6：星星y坐标\n            */\n\n        if (data[2] == 0){ //失败\n            cc.log(\"ws message MID_Bump fail ... \")\n            return\n        }\n        \n        cc.log(\"ws message MID_Bump: \", data[1], data[2], data[3], data[4], data[5], data[6], data[7])\n\n        var nodex = data[4]\n        var nodey = data[6]\n        if (data[3] == 2){\n            nodex = 0 - nodex\n        }\n        if (data[5] == 2){\n            nodey = 0 - nodey\n        }\n        Global.BumpedPlayerId = data[7]\n        var starProp = {\n            nodex: nodex,\n            nodey: nodey\n        }\n        Global.newStarPos.set(Global.newStarKey, starProp)\n    },\n\n    onHeartBeat: function(data){\n        cc.log(\"ws message MID_HeartBeat...\")\n    },\n\n    onStarBorn: function(data) {\n        cc.log(\"ws message MID_StarBorn: \", data[2], data[3], data[4], data[5])\n        /**\n         *  0: 消息ID\n            1：消息长度\n            2: 星星x坐标正负标志\n            3: 星星x坐标\n            4：星星y坐标正负标志\n            5：星星y坐标\n         */\n        var nodex = data[3]\n        var nodey = data[5]\n        if (data[2] == 2){\n            nodex = 0 - nodex\n        }\n        if (data[4] == 2){\n            nodey = 0 - nodey\n        }\n        var starProp = {\n            nodex: nodex,\n            nodey: nodey\n        }\n        Global.newStarPos.set(Global.newStarKey, starProp)\n    },\n\n    onGM: function(data) {\n        cc.log(\"ws message MID_GM...\")\n    },\n\n    Online4Other: function(data) {\n        cc.log(\"ws message MID_Online4Other: \", data[2], data[3], data[4], data[5], data[6])\n        var key = data[6].toString()\n        var nodex = data[3]\n        var nodey = data[5]\n        if (data[2] == 2){\n            nodex = 0 - nodex\n        }\n        if (data[4] == 2){\n            nodey = 0 - nodey\n        }\n\n        cc.log(\"pos: \", nodex, nodey)\n        var playerProp = {\n            sessionId: data[6],\n            nodex: nodex,\n            nodey: nodey\n        }\n        if (Global.PlayerSessionMap.has(key) == false) {\n            Global.PlayerSessionMap.set(key, playerProp)\n        }\n        Global.NewplayerMap.set(key, playerProp)\n        Global.newPlayerIds.push(key)\n        Global.syncOnline4Other = true\n    },\n\n    onRegister: function(data){\n        cc.log(\"ws message MID_Register: \", data[2])\n        Global.RegisterSucc = data[2]\n    },\n\n    /**\n     * \n     * @param {*} data only request, not response...\n     */\n    onSyncPos: function(data) {\n        cc.log(\"ws message MID_SyncPos...\")\n    },\n\n    onMonsterInfo: function(data) {\n        cc.log(\"ws message MID_MonsterInfo: \", data[2], data[3])\n        Global.MonsterScore = data[3]\n    },\n\n    onLogicFrameSync: function(data) {\n        cc.log(\"ws message MID_LogicFrameSync: \", data[2], data[3], data[4], data[5], data[6])\n         \n    }\n}\n\ncc.Class({\n    //extends: cc.Component,\n\n    /*\n    readyState:\n        CONNECTING 0\n        OPEN       1\n        CLOSING    2\n        CLOSED     3\n    */\n   \n    CanSendMsg: function(){\n        if (Global.ws == null){\n            return false\n        }\n\n        return (Global.ws.readyState == WebSocket.CONNECTING || Global.ws.readyState == WebSocket.OPEN)\n    }, \n\n    swConnect: function(){\n        if (Global.ws != null) {\n            //return\n            //cc.log(\"readyState: \", Global.ws.readyState)\n            if (Global.ws.readyState == WebSocket.CONNECTING || Global.ws.readyState == WebSocket.OPEN) { //已经连上就不必再连\n                return\n            }\n        }\n\n        var self = this;\n        cc.log(\"addr: \", Global.wsAddr, Global.ws == null)\n        var ws = new WebSocket(Global.wsAddr);\n        ws.onopen = function(e) {\n            cc.log(\"ws open: \", ws.readyState)\n            //发送心跳\n            HeartCheck.reset().startHeartBeat()\n        }\n\n        ws.onmessage = function(e) {\n            var data = new Uint32Array(e.data)\n            var msgid = data[0] \n            switch (msgid) {\n                case Global.MID_login:\n                    MessageStateFunc.onlogin(data)\n                    break;\n                case Global.MID_logout:\n                    MessageStateFunc.onlogout(data)\n                    break;\n                case Global.MID_move:\n                    MessageStateFunc.onmove(data)\n                    break;\n                case Global.MID_Bump:\n                    MessageStateFunc.onBump(data)\n                    break\n                case Global.MID_HeartBeat:\n                    MessageStateFunc.onHeartBeat(data)\n                    break\n                case Global.MID_StarBorn:\n                    MessageStateFunc.onStarBorn(data)\n                    break\n                case Global.MID_GM:\n                    MessageStateFunc.onGM(data)\n                    break\n                case Global.MID_Online4Other:\n                    MessageStateFunc.Online4Other(data)\n                    break\n                case Global.MID_Register:\n                    MessageStateFunc.onRegister(data)\n                    break\n                case Global.MID_SyncPos:\n                    MessageStateFunc.onSyncPos(data)\n                    break\n                case Global.MID_MonsterInfo:\n                    MessageStateFunc.onMonsterInfo(data)\n                    break\n                case Global.MID_LogicFrameSync:\n                    MessageStateFunc.onLogicFrameSync(data)\n                    break\n                default:\n                    cc.log(\"未知 消息id: \", msgid)\n            }\n\n            //发送心跳\n            HeartCheck.reset().startHeartBeat()\n        }\n\n        ws.onerror = function (e) {\n            cc.log(\"ws error: \", ws.readyState)\n            //Global.ws = null\n            if (HeartCheck.hasDisconnected() == false) {\n                HeartCheck.stopReconnectTimer()\n                HeartCheck.reconnectTimeoutobj = setTimeout(function() {\n                    self.swConnect();\n                }, 1000)\n            }else{\n                HeartCheck.stopReconnectTimer()\n            }\n        }\n\n        ws.onclose = function (e) {\n            cc.log(\"ws close: \", ws.readyState)\n            //Global.ws = null\n            if (HeartCheck.hasDisconnected() == false) {\n                HeartCheck.stopReconnectTimer()\n                HeartCheck.reconnectTimeoutobj = setTimeout(function() {\n                    self.swConnect();\n                }, 1000)\n            }else{\n                HeartCheck.stopReconnectTimer()\n            }\n        }\n\n        cc.log(\"global ws init, state: \", ws.readyState)\n        Global.ws = ws\n    },\n\n    /**\n     * \n     * @param {*} data  具体数据, 1：长度，2：是否广播，3：... 具体消息数据\n     */\n    sendwsmessage: function(data){\n        \n        if (Global.ws == null) {\n            return\n        }\n\n        if (Global.ws != null) {\n            if (Global.ws.readyState == WebSocket.CLOSED || Global.ws.readyState == WebSocket.CLOSING) { //正在断开或者已经断开，则不能发送消息\n                return\n            }\n        }\n\n        //cc.log(\"ws sendwsmessage: \", Global.ws.readyState)\n        Global.ws.send(data)\n    }\n})"]}